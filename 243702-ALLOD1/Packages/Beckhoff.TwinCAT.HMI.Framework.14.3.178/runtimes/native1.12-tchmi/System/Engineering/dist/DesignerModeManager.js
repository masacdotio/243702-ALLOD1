var __runInitializers=this&&this.__runInitializers||function(thisArg,initializers,value){for(var useValue=arguments.length>2,i=0;i<initializers.length;i++)value=useValue?initializers[i].call(thisArg,value):initializers[i].call(thisArg);return useValue?value:void 0},__esDecorate=this&&this.__esDecorate||function(ctor,descriptorIn,decorators,contextIn,initializers,extraInitializers){function accept(f){if(void 0!==f&&"function"!=typeof f)throw new TypeError("Function expected");return f}for(var _,kind=contextIn.kind,key="getter"===kind?"get":"setter"===kind?"set":"value",target=!descriptorIn&&ctor?contextIn.static?ctor:ctor.prototype:null,descriptor=descriptorIn||(target?Object.getOwnPropertyDescriptor(target,contextIn.name):{}),done=!1,i=decorators.length-1;i>=0;i--){var context={};for(var p in contextIn)context[p]="access"===p?{}:contextIn[p];for(var p in contextIn.access)context.access[p]=contextIn.access[p];context.addInitializer=function(f){if(done)throw new TypeError("Cannot add initializers after decoration has completed");extraInitializers.push(accept(f||null))};var result=(0,decorators[i])("accessor"===kind?{get:descriptor.get,set:descriptor.set}:descriptor[key],context);if("accessor"===kind){if(void 0===result)continue;if(null===result||"object"!=typeof result)throw new TypeError("Object expected");(_=accept(result.get))&&(descriptor.get=_),(_=accept(result.set))&&(descriptor.set=_),(_=accept(result.init))&&initializers.unshift(_)}else(_=accept(result))&&("field"===kind?initializers.unshift(_):descriptor[key]=_)}target&&Object.defineProperty(target,contextIn.name,descriptor),done=!0};import{metaDataManager}from"./DesignerModeControlMetaDataMngr.js";let controlMoveManager,controlResizeManager,hierarchyManager,highlightManager,interactionManager,rootControlManager,SyncCmdToCreatorSelectedControls,SyncCmdToCreatorSyncControls;TCHMI_DESIGNER&&(import("./DesignerModeMasterControlMoveMngr.js").then((module=>{controlMoveManager=module.controlMoveManager})),import("./DesignerModeMasterControlResizeMngr.js").then((module=>{controlResizeManager=module.controlResizeManager})),import("./DesignerModeMasterHierarchyMngr.js").then((module=>{hierarchyManager=module.hierarchyManager})),import("./DesignerModeMasterControlHighlightMngr.js").then((module=>{highlightManager=module.highlightManager})),import("./DesignerModeMasterInteractionMngr.js").then((module=>{interactionManager=module.interactionManager})),import("./DesignerModeMasterRootControlMngr.js").then((module=>{rootControlManager=module.rootControlManager})),import("./SyncCmdToCreatorSelectedControls.js").then((module=>{SyncCmdToCreatorSelectedControls=module.SyncCmdToCreatorSelectedControls})),import("./SyncCmdToCreatorSyncControls.js").then((module=>{SyncCmdToCreatorSyncControls=module.SyncCmdToCreatorSyncControls})));let DesignerModeManager=(()=>{var _a,_b;let ___onControlAttached_decorators,___onThemeDataChanged_decorators,_instanceExtraInitializers=[];return class{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(null):void 0;___onControlAttached_decorators=[(_a=TcHmi).CallbackMethod.bind(_a)],___onThemeDataChanged_decorators=[(_b=TcHmi).CallbackMethod.bind(_b)],__esDecorate(this,null,___onControlAttached_decorators,{kind:"method",name:"__onControlAttached",static:!1,private:!1,access:{has:obj=>"__onControlAttached"in obj,get:obj=>obj.__onControlAttached},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onThemeDataChanged_decorators,{kind:"method",name:"__onThemeDataChanged",static:!1,private:!1,access:{has:obj=>"__onThemeDataChanged"in obj,get:obj=>obj.__onThemeDataChanged},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}constructor(){TCHMI_DESIGNER&&(TcHmi.EventProvider.register("onThemeDataChanged",this.__onThemeDataChanged),TcHmi.EventProvider.register("onControlAttached",this.__onControlAttached))}__locked=(__runInitializers(this,_instanceExtraInitializers),!1);__partialRequested={};__onControlAttached(event,tco){if(!(tco&&TCHMI_DESIGNER&&hierarchyManager&&highlightManager&&rootControlManager&&controlMoveManager&&controlResizeManager))return;const purl=tco.getElement()[0].getAttribute("data-tchmi-partial-url");if(hierarchyManager.isDesignerModeControl(tco.getId())){let creatorAttr,isPartialRoot=!1;tchmi_path(purl)===TCHMI_TARGET_PARTIAL&&(isPartialRoot=!0);let bCreatorVisibility=!0;creatorAttr=tco.getElement()[0].getAttribute("data-tchmi-creator-visibility"),creatorAttr&&(creatorAttr=TcHmi.ValueConverter.toType(creatorAttr,"tchmi:framework#/definitions/Visibility")),"Collapsed"===creatorAttr&&(bCreatorVisibility=!1);let bCreatorLocked=!1;creatorAttr=tco.getElement()[0].getAttribute("data-tchmi-creator-locked"),creatorAttr&&(bCreatorLocked=TcHmi.ValueConverter.toType(creatorAttr,"tchmi:general#/definitions/Boolean"));let controlCollapsed=!1;"Collapsed"===tco.getVisibility()&&(controlCollapsed=!0);let ctrlMeta=metaDataManager.getControlMetaData(tco.getId());if(null===ctrlMeta){let controlzindex=0;const aZindex=TcHmi.StyleProvider.getSimpleElementStyle(tco.getElement(),"z-index");void 0!==aZindex["z-index"]&&(controlzindex=parseInt(aZindex["z-index"],10),isNaN(controlzindex)&&(controlzindex=0)),ctrlMeta={id:tco.getId(),parent:null,jControlPosition:highlightManager.createControlPosition(tco,2e3+controlzindex),jHierarchyControlposition:highlightManager.createHierarchyControlPosition(tco,2e3+controlzindex),jOriginalPosition:highlightManager.createOriginalPosition(tco,1e3+controlzindex),jAnchorContainer:highlightManager.createAnchorContainer(tco,3e3+controlzindex,bCreatorLocked),jHierarchyAnchorContainer:highlightManager.createHierarchyAnchorContainer(tco,3e3+controlzindex,bCreatorLocked),isSelected:!1,isSelectedPrev:!1,isPartialRoot,controlCollapsed,isContainerControl:tco.getIsContainerControl()&&!(tco.getElement()?.[0]?.hasAttribute("data-tchmi-designer-ignore")??1),isGridControl:TcHmi.System.Services.controlManager.getDescriptionTypes(tco.getType()).includes("TcHmi.Controls.System.TcHmiGrid"),domVisibility:bCreatorVisibility,locked:bCreatorLocked,controlAttributeDimension:void 0,controlCssPixelDimension:void 0,relativeControlRotation:0,absoluteParentRotation:0},isPartialRoot&&(ctrlMeta.jControlPosition[0].classList.add("tchmi-creator-root-partial"),ctrlMeta.jHierarchyControlposition[0].classList.add("tchmi-creator-root-partial"),ctrlMeta.jOriginalPosition[0].classList.add("tchmi-creator-root-partial"),ctrlMeta.jAnchorContainer[0].classList.add("tchmi-creator-root-partial"),ctrlMeta.jHierarchyAnchorContainer[0].classList.add("tchmi-creator-root-partial")),ctrlMeta.jAnchorContainer[0].classList.toggle("tchmi-creator-control-locked",bCreatorLocked),ctrlMeta.jHierarchyAnchorContainer[0].classList.toggle("tchmi-creator-control-locked",bCreatorLocked),ctrlMeta.jAnchorContainer[0].classList.toggle("tchmi-creator-control-height-inactive","Content"===tco.getHeightMode()),ctrlMeta.jAnchorContainer[0].classList.toggle("tchmi-creator-control-width-inactive","Content"===tco.getWidthMode()),highlightManager.processHighlightType(ctrlMeta),highlightManager.processDomVisibility(ctrlMeta),ctrlMeta.isGridControl&&highlightManager.createGridHighlighter(tco,ctrlMeta),metaDataManager.register(ctrlMeta)}else ctrlMeta.isPartialRoot=isPartialRoot,ctrlMeta.controlCollapsed=controlCollapsed,ctrlMeta.domVisibility=bCreatorVisibility;metaDataManager.refreshControlMetaData(ctrlMeta),controlMoveManager.registerControl(ctrlMeta),hierarchyManager.registerContainerControl(ctrlMeta),controlResizeManager.registerControl(ctrlMeta);let ctco=tco;for(;null!=ctco;){if(ctco.getIsContainerControl()&&!(ctco.getElement()?.[0]?.hasAttribute("data-tchmi-designer-ignore")??1)){let tcoPar=tco.getParent();if(tcoPar&&tcoPar.getId()===ctco.getId()){let ctrlParentMeta=metaDataManager.getControlMetaData(ctco.getId());if(null===ctrlParentMeta){let creatorParentAttr,controlParentZindex=0;controlParentZindex=parseInt(ctco.getElement().css("zIndex"),10),isNaN(controlParentZindex)&&(controlParentZindex=0);let bCreatorParentVisibility=!0;creatorParentAttr=ctco.getElement()[0].getAttribute("data-tchmi-creator-visibility"),creatorParentAttr&&(creatorParentAttr=TcHmi.ValueConverter.toType(creatorAttr,"tchmi:framework#/definitions/Visibility")),"Collapsed"===creatorParentAttr&&(bCreatorParentVisibility=!1);let bCreatorParentLocked=!1;creatorParentAttr=ctco.getElement()[0].getAttribute("data-tchmi-creator-locked"),creatorParentAttr&&(bCreatorParentLocked=TcHmi.ValueConverter.toType(creatorAttr,"tchmi:general#/definitions/Boolean"));let controlParentCollapsed=!1;"Collapsed"===ctco.getVisibility()&&(controlParentCollapsed=!0),ctrlParentMeta={id:ctco.getId(),parent:null,jControlPosition:highlightManager.createControlPosition(ctco,2e3+controlParentZindex),jHierarchyControlposition:highlightManager.createHierarchyControlPosition(ctco,2e3+controlParentZindex),jOriginalPosition:highlightManager.createOriginalPosition(ctco,1e3+controlParentZindex),jAnchorContainer:highlightManager.createAnchorContainer(ctco,3e3+controlParentZindex,bCreatorParentLocked),jHierarchyAnchorContainer:highlightManager.createHierarchyAnchorContainer(ctco,3e3+controlParentZindex,bCreatorParentLocked),isSelected:!1,isSelectedPrev:!1,isPartialRoot:!1,controlCollapsed:controlParentCollapsed,isContainerControl:ctco.getIsContainerControl()&&!(ctco.getElement()?.[0]?.hasAttribute("data-tchmi-designer-ignore")??1),isGridControl:TcHmi.System.Services.controlManager.getDescriptionTypes(ctco.getType()).includes("TcHmi.Controls.System.TcHmiGrid"),domVisibility:bCreatorParentVisibility,locked:bCreatorParentLocked,controlAttributeDimension:void 0,controlCssPixelDimension:void 0,relativeControlRotation:0,absoluteParentRotation:0},ctrlParentMeta.jAnchorContainer[0].classList.toggle("tchmi-creator-control-locked",bCreatorParentLocked),ctrlParentMeta.jHierarchyAnchorContainer[0].classList.toggle("tchmi-creator-control-locked",bCreatorParentLocked),metaDataManager.refreshControlMetaData(ctrlParentMeta),ctrlParentMeta.isGridControl&&highlightManager.createGridHighlighter(ctco,ctrlParentMeta),metaDataManager.register(ctrlParentMeta)}ctrlMeta.parent=ctrlParentMeta}}ctco=ctco.getParent()}let tcoPar=tco.getParent();if(null!==ctrlMeta.parent&&null!==tcoPar){const nextCtrl=tco.getElement().next();let nextCtrlMeta=null;if(0!==nextCtrl.length&&(nextCtrlMeta=metaDataManager.getControlMetaData(nextCtrl[0].id)),nextCtrlMeta)nextCtrlMeta.jOriginalPosition.before(ctrlMeta.jOriginalPosition),nextCtrlMeta.jControlPosition.before(ctrlMeta.jControlPosition),nextCtrlMeta.jControlPosition.before(ctrlMeta.jHierarchyControlposition),nextCtrlMeta.jAnchorContainer.before(ctrlMeta.jAnchorContainer),nextCtrlMeta.jAnchorContainer.before(ctrlMeta.jHierarchyAnchorContainer);else if(ctrlMeta.parent.isGridControl){let targetRowIndex=tco.getGridRowIndex();(!targetRowIndex||targetRowIndex>=tcoPar.__rowOptions.length)&&(targetRowIndex=0);let targetColumnIndex=tco.getGridColumnIndex();(!targetColumnIndex||targetColumnIndex>=tcoPar.__columnOptions.length)&&(targetColumnIndex=0);const targetCell=ctrlMeta.parent.jHierarchyControlposition.children("[data-tchmi-creator-grid-rowindex="+targetRowIndex+"][data-tchmi-creator-grid-cellindex="+targetColumnIndex+"]");0===targetCell.length&&TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Fatal internal error: Could not find target grid cell for "+tco.getParent().getId()+" to attach highlight container."),targetCell.append(ctrlMeta.jOriginalPosition),targetCell.append(ctrlMeta.jControlPosition),targetCell.append(ctrlMeta.jHierarchyControlposition),targetCell.append(ctrlMeta.jAnchorContainer),targetCell.append(ctrlMeta.jHierarchyAnchorContainer)}else ctrlMeta.parent.jHierarchyControlposition.append(ctrlMeta.jOriginalPosition),ctrlMeta.parent.jHierarchyControlposition.append(ctrlMeta.jControlPosition),ctrlMeta.parent.jHierarchyControlposition.append(ctrlMeta.jHierarchyControlposition),ctrlMeta.parent.jHierarchyAnchorContainer.append(ctrlMeta.jAnchorContainer),ctrlMeta.parent.jHierarchyAnchorContainer.append(ctrlMeta.jHierarchyAnchorContainer)}else{const HighlightingContainer=rootControlManager.getViewPortHighlightingContainer();HighlightingContainer.append(ctrlMeta.jOriginalPosition[0],ctrlMeta.jControlPosition[0],ctrlMeta.jHierarchyControlposition[0],ctrlMeta.jAnchorContainer[0],ctrlMeta.jHierarchyAnchorContainer[0]);const backgroundTarget=rootControlManager.getBackgroundTarget();document.body.append(backgroundTarget,HighlightingContainer)}let ctrlAsyncData=highlightManager.requestAsyncHighlighterUpdateForControl(tco);ctrlAsyncData.moved=!0,ctrlAsyncData.resized=!0,ctrlMeta.isPartialRoot&&rootControlManager.setRootControl(tco,ctrlMeta)}}__onThemeDataChanged(_event){metaDataManager.refreshControlMetaData()}resyncSelectedControls(){if(metaDataManager.getSelectedControlsMetaDataHasChanged()){let metaData=metaDataManager.getSelectedControlsMetaData();const cmd={name:"SelectedControls",targetPartial:TCHMI_TARGET_PARTIAL,controls:Object.keys(metaData),replyTo:null};if(!SyncCmdToCreatorSelectedControls)return void TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Internal error: SyncCmdToCreatorSelectedControls not loaded");new SyncCmdToCreatorSelectedControls(cmd).send(),metaDataManager.resetSelectedControlsMetaDataHasChanged()}}resyncControls(){if(metaDataManager.getChangedControlsMetaDataHasChanged()){let metaData=metaDataManager.getChangedControlsMetaData();const cmd={name:"SyncControls",frameworkType:TCHMI_DESIGNER?"Designer":"LiveView",targetPartial:TCHMI_TARGET_PARTIAL,controls:[],replyTo:null};for(const id of Object.keys(metaData)){const tco=TcHmi.Controls.get(id);if(!tco)continue;let markup=tco.getPcElement()[0].outerHTML;cmd.controls.push({targetControl:id,descriptionPath:TcHmi.System.Services.controlManager.getDescriptionPath(tco.getType()),controlHtml:markup})}if(!SyncCmdToCreatorSyncControls)return void TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Internal error: SyncCmdToCreatorSyncControls not loaded");new SyncCmdToCreatorSyncControls(cmd).send(),metaDataManager.resetChangedControlsMetaData()}}syncControl(targetPartial,targetControl,controlHtml){if(!targetControl)return TcHmi.Log.debug("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Synchronization failed. Invalid target control."),!1;if(!controlHtml)return TcHmi.Log.debug("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Synchronization failed. Invalid or missing html."),!1;if(!controlHtml.endsWith("</div>"))return TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Synchronization failed. Incomplete html."),!1;const tco=TcHmi.Controls.get(targetControl);if(!tco)return TcHmi.Log.debug("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Synchronization failed. Control="+targetControl+" not found in control cache."),!1;let tempDiv=document.createElement("div");tempDiv.innerHTML=controlHtml;let jControlHtmlNew=$(tempDiv.firstElementChild);if(0===jControlHtmlNew.length)return!1;if(1!==jControlHtmlNew.length&&(jControlHtmlNew=jControlHtmlNew.filter("div[data-tchmi-type]"),1!==jControlHtmlNew.length))return TcHmi.Log.debug("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Synchronization failed. Only one control is allowed but got "+jControlHtmlNew.length),!1;const controlType=jControlHtmlNew[0].getAttribute("data-tchmi-type");if(!controlType)return TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Synchronization failed for control="+targetControl+". Missing attribute=data-tchmi-type."),!1;const controlId=jControlHtmlNew[0].id;if(!controlId)return TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Synchronization failed for control="+targetControl+". Missing attribute=id."),!1;let jControlHtmlCurrent=tco.getPcElement().clone();if(0===jControlHtmlCurrent.length)return!1;if(controlType!==tco.getType())return TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Synchronization failed for incompatible control="+targetControl+". Incoming change is for control type="+controlType+" but local control has type="+tco.getType()),!1;if(jControlHtmlNew[0].outerHTML===jControlHtmlCurrent[0].outerHTML)return!1;let attrsCurrent=tco.getAttrs(),attrsNewRes=TcHmi.System.resolveAttributesFromControlElement(jControlHtmlNew[0]);TCHMI_DESIGNER&&(attrsNewRes.error||TcHmi.Engineering.ErrorPane.remove(`${controlId}.attributeResolveError`));const ctrlMeta=metaDataManager.getControlMetaData(targetControl);let newId=attrsNewRes.value.id.value,tcoPar=tco.getParent();if(targetControl!==newId&&tcoPar){let jParentPcElementClone=tcoPar.getPcElement().clone(),tempDiv=document.createElement("div");return tempDiv.innerHTML=controlHtml,jParentPcElementClone.find("#"+tchmi_css_escape_selector(targetControl)).replaceWith($(tempDiv.firstElementChild)),this.syncControl(targetPartial,jParentPcElementClone[0].id,jParentPcElementClone[0].outerHTML),ctrlMeta&&ctrlMeta.isSelected&&TcHmi.EventProvider.register(newId+".onAttached",((event,_data)=>{this.select(newId,!0),event.destroy()})),!0}TcHmi.Engineering.ErrorPane.remove(tco.getId()+"requiredAttributeTouched");const creatorAttributesNotSynced={"data-tchmi-creator-visibility":!0,"data-tchmi-creator-locked":!0,"data-tchmi-creator-viewport-width":!0,"data-tchmi-creator-viewport-height":!0,"data-tchmi-zindex":!0};let attrsToProcess=[],attrsToRemove=[];for(let keyNew in attrsNewRes.value){const attrNew=attrsNewRes.value[keyNew],attrCurrent=attrsCurrent[keyNew];if(void 0===attrCurrent||!tchmi_equal(attrNew.value,attrCurrent.value)){if(attrNew.descr&&!0===attrNew.descr.requiredOnCompile){TcHmi.Engineering.ErrorPane.add(tco.getId()+"requiredAttributeTouched","Synchronization problem while changing attribute "+attrNew.descr.name+" of control="+tco.getId()+". It is not possible to change this attribute in runtime. Please save and reload this window.",TcHmi.Engineering.ErrorPane.MessageType.Error);continue}attrsToProcess.push(attrNew)}creatorAttributesNotSynced[attrNew.name]&&delete creatorAttributesNotSynced[attrNew.name]}for(let keyCurrent in attrsCurrent){let attrCurrent=attrsCurrent[keyCurrent];if(void 0===attrsNewRes.value[attrCurrent.name]){if(attrCurrent.descr&&!0===attrCurrent.descr.requiredOnCompile){TcHmi.Engineering.ErrorPane.add(tco.getId()+"requiredAttributeTouched","Synchronization problem while removing attribute "+attrCurrent.descr.name+" of control="+tco.getId()+". This attribute is not allowed to be deleted.",TcHmi.Engineering.ErrorPane.MessageType.Error);continue}attrsToRemove.push(attrCurrent)}}for(let missingCreatorAttribute in creatorAttributesNotSynced){switch(missingCreatorAttribute){case"data-tchmi-creator-visibility":null!==ctrlMeta&&(ctrlMeta.domVisibility=!0);break;case"data-tchmi-creator-locked":null!==ctrlMeta&&(ctrlMeta.locked=!1);break;case"data-tchmi-zindex":if(null!==ctrlMeta){const controlzindex=0;ctrlMeta.jOriginalPosition.css("z-index",1e3+controlzindex),ctrlMeta.jControlPosition.css("z-index",2e3+controlzindex),ctrlMeta.jHierarchyControlposition.css("z-index",2e3+controlzindex),ctrlMeta.jAnchorContainer.css("z-index",3e3+controlzindex),ctrlMeta.jHierarchyAnchorContainer.css("z-index",3e3+controlzindex)}}tco.getElement()[0].removeAttribute(missingCreatorAttribute),tco.getPcElement()[0].removeAttribute(missingCreatorAttribute),delete tco.getAttrs()[missingCreatorAttribute]}if(null!=attrsToProcess)for(let i=0,ii=attrsToProcess.length;i<ii;i++){const attr=attrsToProcess[i];switch(attr.name.toLowerCase()){case"data-tchmi-creator-visibility":if(TCHMI_DESIGNER&&null!==ctrlMeta)if("Collapsed"===TcHmi.ValueConverter.toType(attr.value,"tchmi:framework#/definitions/Visibility"))ctrlMeta.domVisibility=!1;else ctrlMeta.domVisibility=!0;tco.getElement()[0].setAttribute(attr.name,attr.value),tco.getAttrs()[attr.name]=attr;break;case"data-tchmi-creator-locked":TCHMI_DESIGNER&&null!==ctrlMeta&&(ctrlMeta.locked=TcHmi.ValueConverter.toType(attr.value,"tchmi:general#/definitions/Boolean")),tco.getElement()[0].setAttribute(attr.name,attr.value),tco.getAttrs()[attr.name]=attr;break;case"data-tchmi-creator-viewport-width":case"data-tchmi-creator-viewport-height":tco.getElement()[0].setAttribute(attr.name,attr.value),tco.getAttrs()[attr.name]=attr;break;case"data-tchmi-zindex":if(TCHMI_DESIGNER&&null!==ctrlMeta){let controlzindex=parseInt(attr.value,10);isNaN(controlzindex)&&(controlzindex=0),controlzindex>=0&&(ctrlMeta.jOriginalPosition.css("z-index",1e3+controlzindex),ctrlMeta.jControlPosition.css("z-index",2e3+controlzindex),ctrlMeta.jHierarchyControlposition.css("z-index",2e3+controlzindex),ctrlMeta.jAnchorContainer.css("z-index",3e3+controlzindex),ctrlMeta.jHierarchyAnchorContainer.css("z-index",3e3+controlzindex))}}}if("TcHmi.Controls.System.TcHmiHtmlHost"===tco.getType()&&"setContent"in tco&&"function"==typeof tco.setContent){let contentNew=jControlHtmlNew[0].innerHTML;contentNew&&tco.setContent(contentNew),contentNew=""}let isTargetPartialUcRelated=!1;if(TCHMI_DESIGNER){let uc=null,temp=tco;for(;temp;){if("TcHmi.Controls.System.TcHmiUserControl"===temp.getType()){uc=temp;break}temp=temp.getParent()}if(uc){let purl=tchmi_path(uc.getElement()[0].getAttribute("data-tchmi-partial-url"));purl&&purl===tchmi_path(TCHMI_TARGET_PARTIAL)&&(isTargetPartialUcRelated=!0)}}for(let i=0,ii=attrsToRemove.length;i<ii;i++){let attr=attrsToRemove[i];if(void 0===attr.descr||null===attr.descr)continue;if(attr.valueType===TcHmi.System.ControlAttributeValueType.Simple&&tco.getElement()[0].removeAttribute(attr.name),delete tco.getAttrs()[attr.name],attr.descr.readOnly)continue;let isSymbolExpression=TcHmi.Symbol.isSymbolExpression(attr.value),isSymbolExpressionEscaped=TcHmi.Symbol.isSymbolExpressionEscaped(attr.value);if(isSymbolExpression&&!isSymbolExpressionEscaped)try{TcHmi.System.Services.bindingManager.removeBinding(attr.descr.propertyName,tco,!0)}catch(e){TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Synchronization failed. An uncaught exception occurred while removing binding for attribute="+attr.descr.propertyName+" of control="+tco.getId()+":\n",e)}else{let error=TcHmi.System.Services.controlManager.setControlPropertyByAttribute(tco,attr.descr,null);error&&error.code!==TcHmi.Errors.NONE&&TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] "+TcHmi.Log.buildMessage(error))}}for(let i=0,ii=attrsToProcess.length;i<ii;i++){let attr=attrsToProcess[i];if(void 0===attr.descr||null===attr.descr)continue;if(attr.valueType===TcHmi.System.ControlAttributeValueType.Simple&&tco.getElement()[0].setAttribute(attr.name,attr.value),tco.getAttrs()[attr.name]=attr,attr.descr.readOnly)continue;let isSymbolExpression=TcHmi.Symbol.isSymbolExpression(attr.value),isSymbolExpressionEscaped=TcHmi.Symbol.isSymbolExpressionEscaped(attr.value);if(isSymbolExpression&&!isSymbolExpressionEscaped){let designerPartialParamExpression=null;if(isTargetPartialUcRelated){let expressionPrepared=attr.value.replace(/%pp%/g,"%pp%TCHMI_TARGET_DESIGNER_PARTIALPARAM::");designerPartialParamExpression=new TcHmi.SymbolExpression(expressionPrepared)}let bResetBinding=!0,existingBinding=TcHmi.System.Services.bindingManager.getBinding(attr.descr.propertyName,tco);if(null!=existingBinding){let existingBindingSymbol=existingBinding.getSymbol();if(null!=existingBindingSymbol){let existingBindingSymbolExpression=existingBindingSymbol.getExpression();if(null!=existingBindingSymbolExpression)if(designerPartialParamExpression){if(designerPartialParamExpression.toString()===existingBindingSymbolExpression.toString()){bResetBinding=!1;break}}else if(attr.value===existingBindingSymbolExpression.toString()){bResetBinding=!1;break}}}if(bResetBinding)try{if(TcHmi.System.Services.bindingManager.removeBinding(attr.descr.propertyName,tco,!1),designerPartialParamExpression){const dPPExpression=designerPartialParamExpression.toString();dPPExpression?TcHmi.System.Services.bindingManager.createBinding(dPPExpression,attr.descr.propertyName,tco):TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Synchronization failed. designer partial param expression invalid while creating binding for attribute="+attr.descr.propertyName+" of control="+tco.getId()+".")}else TcHmi.System.Services.bindingManager.createBinding(attr.value,attr.descr.propertyName,tco)}catch(e){TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Synchronization failed. An uncaught exception occurred while creating binding for attribute="+attr.descr.propertyName+" of control="+tco.getId()+":\n",e)}}else{let prepValue=attr.value;isSymbolExpressionEscaped&&(prepValue=TcHmi.Symbol.escapeSymbolExpression(prepValue));try{TcHmi.System.Services.bindingManager.removeBinding(attr.descr.propertyName,tco,!1)}catch(e){TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Synchronization failed. An uncaught exception occurred while removing binding from attribute="+attr.descr.propertyName+" of control="+tco.getId()+":\n",e)}let error=TcHmi.System.Services.controlManager.setControlPropertyByAttribute(tco,attr.descr,prepValue);error&&error.code!==TcHmi.Errors.NONE&&(error.exception?TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] "+TcHmi.Log.buildMessage(error),"\nException:",error.exception):TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] "+TcHmi.Log.buildMessage(error)))}}if(tco.getIsContainerControl()&&!(tco.getElement()?.[0]?.hasAttribute("data-tchmi-designer-ignore")??1)){let jContentChildren=jControlHtmlNew.children(),jCurrentChildren=jControlHtmlCurrent.children("div[data-tchmi-type]"),removed=[];for(let i=0,ii=jCurrentChildren.length;i<ii;i++){let jCurrentChild=jCurrentChildren.eq(i),bDelete=!0;for(let j=0,jj=jContentChildren.length;j<jj;j++)if("DIV"===jContentChildren[j].nodeName&&jContentChildren[j].hasAttribute("data-tchmi-type")&&jCurrentChild[0].id===jContentChildren[j].id){bDelete=!1;break}if(bDelete){removed.push(jCurrentChild[0].id);let removedControl=TcHmi.Controls.get(jCurrentChild[0].id);if(removedControl){removedControl.__getKeepAlive()&&removedControl.__setKeepAlive(!1),removedControl.destroy()}}}let replaced=[];for(let i=0,ii=jContentChildren.length;i<ii;i++){if("DIV"!==jContentChildren[i].nodeName||!jContentChildren[i].hasAttribute("data-tchmi-type"))continue;if(removed.includes(jContentChildren[i].id))continue;const existingControl=TcHmi.Controls.get(jContentChildren[i].id);if(existingControl&&jContentChildren[i].getAttribute("data-tchmi-type")!==existingControl.getType())replaced.push(jContentChildren[i].id),existingControl.__setKeepAlive(!1),existingControl.destroy();else try{this.syncControl(targetPartial,jContentChildren[i].id,jContentChildren[i].outerHTML)}catch(e){TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Synchronization failed. An uncaught exception occurred while syncing control="+jContentChildren[i].id+":\n",e)}}const ctrlMap=TcHmi.Controls.getMap();let controlIndex=-1;for(let i=0,ii=jContentChildren.length;i<ii;i++)if("DIV"===jContentChildren[i].nodeName&&jContentChildren[i].hasAttribute("data-tchmi-type")&&(controlIndex++,!Array.from(jCurrentChildren).some((currentElem=>!replaced.includes(currentElem.id)&&currentElem.id===jContentChildren[i].id&&ctrlMap.has(currentElem.id)))))try{const compileResult=this.createControl(targetControl,controlIndex,jContentChildren[i].outerHTML,null);compileResult.error&&TcHmi.Log.errorEx(`[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Synchronization failed. Compile of ${jContentChildren[i].id} has failed:`,TcHmi.Log.buildMessage(compileResult.details))}catch(e){TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Synchronization failed. Unexpected An uncaught exception occurred while creating control="+jContentChildren[i].id+":\n",e)}}const pcElementOld=tco.getPcElement();if(tco.__setPcElement(jControlHtmlNew.clone()),void 0!==tco.getParent()&&null!==tco.getParent()){let temp=tco.getParent();for(;null!==temp;)temp.getPcElement().find("#"+tchmi_css_escape_selector(pcElementOld[0].id)).replaceWith(tco.getPcElement().clone()),temp=temp.getParent()}if(TCHMI_DESIGNER&&hierarchyManager&&hierarchyManager.isDesignerModeControl(targetControl)&&rootControlManager&&highlightManager){const tCtrlMeta=metaDataManager.refreshControlMetaData(targetControl);if(null!=tCtrlMeta){let ctrlAsyncData=highlightManager.requestAsyncHighlighterUpdateForControl(tco);if(ctrlAsyncData.moved=!0,ctrlAsyncData.resized=!0,tCtrlMeta.isPartialRoot);else if(tco.getParent()){let recursiveControl=tco.getParent();do{if(!recursiveControl||"Content"!==recursiveControl.getHeightMode()&&"Content"!==recursiveControl.getWidthMode())recursiveControl=null;else{const parentCtrlMeta=metaDataManager.getControlMetaData(recursiveControl.getId());if(!parentCtrlMeta){recursiveControl=null;break}if(parentCtrlMeta.isPartialRoot){rootControlManager.setCreatorViewPortPosition(recursiveControl);break}recursiveControl=recursiveControl.getParent()}}while(null!==recursiveControl)}}}return null!==ctrlMeta&&(ctrlMeta.jAnchorContainer[0].classList.toggle("tchmi-creator-control-locked",ctrlMeta.locked),ctrlMeta.jHierarchyAnchorContainer[0].classList.toggle("tchmi-creator-control-locked",ctrlMeta.locked),ctrlMeta.jAnchorContainer[0].classList.toggle("tchmi-creator-control-height-inactive","Content"===tco.getHeightMode()),ctrlMeta.jAnchorContainer[0].classList.toggle("tchmi-creator-control-width-inactive","Content"===tco.getWidthMode())),!0}createControl(targetParentControl,domPos,controlHtml,callback=null){let tempDiv=document.createElement("div");tempDiv.innerHTML=controlHtml;let jControlHTML=$(tempDiv.firstElementChild);if(0===jControlHTML.length)return{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],domain:"TcHmi.System.Engineering.DesignerModeManager",reason:"Invalid control html."},control:void 0};jControlHTML[0].remove();let controlType=jControlHTML[0].getAttribute("data-tchmi-type");if(!controlType)return{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],domain:"TcHmi.System.Engineering.DesignerModeManager",reason:"Invalid control html. Missing attribute=data-tchmi-type"},control:void 0};let controlId=jControlHTML[0].id;if(!controlId)return{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],domain:"TcHmi.System.Engineering.DesignerModeManager",reason:"Invalid control html. Missing attribute=id"},control:void 0};if(TcHmi.Controls.get(controlId))return{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],domain:"TcHmi.System.Engineering.DesignerModeManager",reason:'Id "'+controlId+'" does already exist.'},control:void 0};let tpco=null;if(targetParentControl){if(tpco=TcHmi.Controls.get(targetParentControl),!tpco)return TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Failed to create control. Target parent control="+targetParentControl+" not found in control cache."),{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],domain:"TcHmi.System.Engineering.DesignerModeManager",reason:"Target parent control="+targetParentControl+" not found in control cache."},control:void 0}}else{if("TcHmi.Controls.System.TcHmiView"!==controlType&&"TcHmi.Controls.System.TcHmiContent"!==controlType&&"TcHmi.Controls.System.TcHmiUserControl"!==controlType)return{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],domain:"TcHmi.System.Engineering.DesignerModeManager",reason:'Only controls of type "TcHmi.Controls.System.TcHmiView", "TcHmi.Controls.System.TcHmiContent" or "TcHmi.Controls.System.TcHmiUserControl" are valid as a root element.'},control:void 0};jControlHTML.attr("data-tchmi-partial-url",tchmi_path(TCHMI_TARGET_PARTIAL)).attr("data-tchmi-creator-partial-key",TCHMI_TARGET_PARTIAL)}const compileResult=TcHmi.System.Services.controlManager.compile(jControlHTML[0],tpco,{pos:domPos});if(compileResult.error!==TcHmi.Errors.NONE||!compileResult.control)return compileResult;const tco=compileResult.control;if(tpco){if(!tpco.getIsContainerControl()||(tco.getElement()?.[0]?.hasAttribute("data-tchmi-designer-ignore")??1)||"function"!=typeof tpco.addChild)return{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],domain:"TcHmi.System.Engineering.DesignerModeManager",reason:'Can not add child to a not "TcHmiContainerControl" based control! Requested parent target control='+tpco.getId()+" has type="+tpco.getType()},control:void 0};{const updateParents=ctrl=>{const parentCtrl=ctrl.getParent();if(!parentCtrl)return;const controlId=ctrl.getId(),pcElem=ctrl.getPcElement(),parentPcElem=parentCtrl.getPcElement();for(const childElem of parentPcElem[0].children)if(childElem.id===controlId){childElem.replaceWith(pcElem.clone()[0]);break}updateParents(parentCtrl)};if(0===domPos)tpco.getPcElement().prepend(tco.getPcElement().clone());else{const jContentChildren=tpco.getPcElement().children();let intDomPos=-1;for(let controlCounter=0,i=0,ii=jContentChildren.length;i<ii;i++)if("DIV"===jContentChildren[i].nodeName&&jContentChildren[i].hasAttribute("data-tchmi-type")){if(controlCounter++,domPos===controlCounter){intDomPos=i;break}if(domPos<controlCounter)break}-1===intDomPos?tpco.getPcElement().append(tco.getPcElement().clone()):jContentChildren.eq(intDomPos).after(tco.getPcElement().clone())}updateParents(tpco)}}else{const tcoType=tco.getType();if("TcHmi.Controls.System.TcHmiView"!==tcoType&&"TcHmi.Controls.System.TcHmiUserControl"!==tcoType&&"TcHmi.Controls.System.TcHmiContent"!==tcoType)return{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],domain:"TcHmi.System.Engineering.DesignerModeManager",reason:"Can not load root element because it is of type="+tcoType+" but only controls of type TcHmi.Controls.System.TcHmiView, TcHmi.Controls.System.TcHmiContent and TcHmi.Controls.System.TcHmiUserControl are allowed as root element."},control:void 0};TcHmi.System.Services.viewManager.loadViewObject(tco)}let tcoId=tco.getId();return TcHmi.Engineering.ErrorPane.remove(tcoId+"requiredAttributeTouched"),TcHmi.EventProvider.register(tcoId+".onAttached",((event,_data)=>{event.destroy(),"function"==typeof callback&&callback.call(this,{error:TcHmi.Errors.NONE})})),{error:TcHmi.Errors.NONE,control:tco}}select(controlId,bIgnoreSync=!1){if(!TCHMI_DESIGNER)return;const ctrlMeta=metaDataManager.getControlMetaData(controlId);if(null===ctrlMeta)return void TcHmi.Log.debug("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Failed to select control: "+controlId);TcHmi.Controls.get(ctrlMeta.id)&&(ctrlMeta.isSelectedPrev=ctrlMeta.isSelected,ctrlMeta.isSelected=!0,metaDataManager.selectControl(ctrlMeta),highlightManager?.processHighlightType(ctrlMeta),bIgnoreSync||this.resyncSelectedControls())}unselect(controlId,bIgnoreSync=!1){if(!TCHMI_DESIGNER)return;const ctrlMeta=metaDataManager.getControlMetaData(controlId);if(null===ctrlMeta)return;let tco=TcHmi.Controls.get(ctrlMeta.id);if(!tco)return;ctrlMeta.isSelected=!1,metaDataManager.unselectControl(ctrlMeta),ctrlMeta.isSelectedPrev=!1,highlightManager?.processHighlightType(ctrlMeta);let tcoPar=tco.getParent();if(tcoPar&&ctrlMeta.parent){let childSelected=!1;for(let childCtrl of tcoPar.getChildren()){const ctrlChildMeta=metaDataManager.getControlMetaData(childCtrl.getId());if(ctrlChildMeta&&ctrlChildMeta.isSelected){childSelected=!0;break}}ctrlMeta.parent.jControlPosition[0].classList.toggle("tchmi-creator-childcontrol-selected",childSelected)}bIgnoreSync||this.resyncSelectedControls()}selectEach(bIgnoreSync){let selectionHasChanged=this.unselectEach(!0);const controlsMetaData=metaDataManager.getControlMetaData();for(const[id,ctrlMeta]of Object.entries(controlsMetaData))ctrlMeta.isPartialRoot||(this.select(id,!0),selectionHasChanged=!0);return!bIgnoreSync&&selectionHasChanged&&this.resyncSelectedControls(),selectionHasChanged}unselectEach(bIgnoreSync){let selectionHasChanged=!1;const controlsMetaData=metaDataManager.getControlMetaData();for(const[id,ctrlMeta]of Object.entries(controlsMetaData))ctrlMeta.isSelected&&(this.unselect(id,!0),selectionHasChanged=!0);return!bIgnoreSync&&selectionHasChanged&&this.resyncSelectedControls(),selectionHasChanged}setControlLocked(targetControl,bLocked){let ctrlMeta=metaDataManager.getControlMetaData(targetControl);null!==ctrlMeta&&(ctrlMeta.locked=bLocked,ctrlMeta.jAnchorContainer[0].classList.toggle("tchmi-creator-control-locked",bLocked),ctrlMeta.jHierarchyAnchorContainer[0].classList.toggle("tchmi-creator-control-locked",bLocked));let tco=TcHmi.Controls.get(targetControl);tco&&(bLocked?(tco.getElement()[0].setAttribute("data-tchmi-creator-locked","True"),tco.getPcElement()[0].setAttribute("data-tchmi-creator-locked","True")):(tco.getElement()[0].removeAttribute("data-tchmi-creator-locked"),tco.getPcElement()[0].removeAttribute("data-tchmi-creator-locked")))}lock(){if(this.__locked=!0,TCHMI_LIVEVIEW)TcHmi.System.Services.dialogManager.updateTextEx("__TcHmiDesignerLock",TcHmi.System.Services.localization.getText("Changes_To_Project_Require_Reload",{level:TcHmi.Locale.Level.Engineering}),{severity:TcHmi.DialogManager.DialogSeverity.Warning,buttonReload:!0}),TcHmi.System.Services.dialogManager.showDialog("__TcHmiDesignerLock",!0,TcHmi.DialogManager.DialogType.Overlay);else if(TCHMI_DESIGNER){TcHmi.System.Services.dialogManager.updateTextEx("__TcHmiDesignerLock","",{severity:TcHmi.DialogManager.DialogSeverity.Warning}),TcHmi.System.Services.dialogManager.showDialog("__TcHmiDesignerLock",!0,TcHmi.DialogManager.DialogType.Overlay),this.unselectEach(!0);const v=TcHmi.System.Services.viewManager.getView();null!=v&&TcHmi.StyleProvider.setSimpleElementStyle(v.getElement(),"filter","blur(2px)")}document.body.style.overflow="hidden"}unlock(){throw new Error("Not implemented!")}isLocked(){return this.__locked}__settings={theme:{ChessboardLight:null,ChessboardDark:null},enableSnapping:!0,snapToControls:!0,snapToInnerContainerSides:!0,snapDistanceToControls:10,untransformedColor:null,selectionHighlightColor:null,unSelectedHighlightColor:null,selectedSecondaryColor:null,snapHighlightColor:null,scaleFactors:[1]};getSettings(){return this.__settings}updateSettings(valueNew){tchmi_equal(this.__settings,valueNew)||(this.__settings=valueNew,highlightManager?.updateEngineeringStyles(),interactionManager?.clearControlSnapPositionCache(),interactionManager?.refreshControlSnapPositionCache())}}})();export{DesignerModeManager};export const designerModeManager=new DesignerModeManager;