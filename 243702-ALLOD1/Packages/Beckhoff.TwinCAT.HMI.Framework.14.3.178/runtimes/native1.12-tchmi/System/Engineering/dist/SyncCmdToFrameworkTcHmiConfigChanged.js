import{SyncCmdToFramework,registerCommand}from"./SyncCmdToFramework.js";import{designerModeManager}from"./DesignerModeManager.js";import{resourceInjectionManager}from"./DesignerModeResourceInjectionManager.js";let rootControlManager;TCHMI_ENGINEERING||TcHmi.Log.errorEx(`Internal error: The file "${import.meta.url}" is restricted to use within the designer or live view.`),TCHMI_DESIGNER&&import("./DesignerModeMasterRootControlMngr.js").then((module=>{rootControlManager=module.rootControlManager})).catch((ex=>{TcHmi.Log.error("Failed to load rootControlManager in Framework SyncCmdToFrameworkTcHmiConfigChanged: "+ex)}));export class SyncCmdToFrameworkTcHmiConfigChanged extends SyncCmdToFramework{constructor(cmd){super(cmd)}__refreshBaseConfig(config,configOld){config.scaleMode!==configOld.scaleMode&&TcHmi.System.Services.viewManager.setScaleMode(config.scaleMode),TCHMI_DESIGNER?config.creatorSettings&&config.creatorSettings.viewport&&(config.creatorSettings.viewport.defaultHeight!==configOld.creatorSettings.viewport.defaultHeight||config.creatorSettings.viewport.defaultWidth!==configOld.creatorSettings.viewport.defaultWidth)&&rootControlManager?.setCreatorViewPortPosition(TcHmi.System.Services.viewManager.getView()):config.startupView!==configOld.startupView&&TcHmi.System.Services.viewManager.loadView(config.startupView),config.activeTheme!==configOld.activeTheme?TcHmi.System.Services.themeManager.setTheme(config.activeTheme,!0):tchmi_equal(config.themes,configOld.themes)&&tchmi_equal(config.dependencyFiles?.filter((value=>"Stylesheet"===value.type)),configOld.dependencyFiles?.filter((value=>"Stylesheet"===value.type)))||TcHmi.System.Services.themeManager.processActiveTheme(),tchmi_equal(config.trigger,configOld.trigger)||(TcHmi.System.destroyGlobalTrigger&&(TcHmi.System.destroyGlobalTrigger(),TcHmi.System.destroyGlobalTrigger=null),TcHmi.System.destroyGlobalTrigger=TcHmi.System.Services.triggerManager.register(tchmi_clone_object(config.trigger))),TCHMI_ENGINEERING&&TCHMI_LIVEVIEW&&!tchmi_equal(config.tcHmiServer,configOld.tcHmiServer)&&TcHmi.System.Services.serverManager.refreshSubscriptions()}__loadViewPartial(v,callback){let vm=null;if(v.preload&&!TCHMI_DESIGNER){let xhr=new XMLHttpRequest;xhr.open("GET",tchmi_encode_uri_components(v.url)+"?preventcache="+Math.random()),xhr.addEventListener("load",(_event=>{200===xhr.status?vm=xhr.responseText:TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+v.url+" Details: HTTP error "+xhr.status+" "+xhr.statusText),TcHmi.Callback.callSafeEx(callback,null,v,vm)})),xhr.addEventListener("error",(_event=>{TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+v.url+" Details: HTTP error "+xhr.status+" "+xhr.statusText),TcHmi.Callback.callSafeEx(callback,null,v,vm)})),xhr.send()}}__loadViewPartialCallback(v,vm){if(null==vm)return;let cacheEntry,cleanUrl=tchmi_path(v.url);if(void 0!==v.url&&null!==v.url&&v.preload&&(cacheEntry={markup:vm},TcHmi.System.Data.Caches.partialMarkupCache.set(cleanUrl,cacheEntry)),v.preload&&void 0!==v.url&&null!==v.url&&!TCHMI_DESIGNER){let tempDiv=document.createElement("div");if(tempDiv.innerHTML=vm,tempDiv.firstElementChild){const tco=TcHmi.System.Services.controlManager.compile(tempDiv.firstElementChild).control;void 0!==tco&&(cacheEntry&&(cacheEntry.partialId=tco.getId()),tco.__setKeepAlive(!0),tco.getElement().attr("data-tchmi-partial-url",v.url))}}TcHmi.EventProvider.raise("System.onViewCreated",{url:cleanUrl})}__refreshViewPartials(views,viewsOld){if(null==views||null==viewsOld)return;let viewsRemoved=[];for(let i=0,ii=viewsOld.length;i<ii;i++){let po=viewsOld[i],bExists=!1;for(let j=0,jj=views.length;j<jj;j++){if(views[j].url===po.url){bExists=!0;break}}bExists||viewsRemoved.push(po)}let viewsCreated=[];for(let i=0,ii=views.length;i<ii;i++){let p=views[i],bExists=!1;for(let j=0,jj=viewsOld.length;j<jj;j++){let po=viewsOld[j];if(p.url===po.url){bExists=!0;break}}bExists||viewsCreated.push(p)}for(let i=0,ii=viewsRemoved.length;i<ii;i++){let v=viewsRemoved[i];if(void 0===v.url||null===v.url)continue;let cleanUrl=tchmi_path(v.url);TcHmi.System.Data.Caches.partialMarkupCache.delete(cleanUrl),TcHmi.EventProvider.raise("System.onViewRemoved",{url:cleanUrl})}for(let i=0,ii=viewsCreated.length;i<ii;i++){let v=viewsCreated[i];this.__loadViewPartial(v,this.__loadViewPartialCallback)}}__refreshContentPartials(content,contentOld){if(null==content||null==contentOld)return;let contentRemoved=[];for(let i=0,ii=contentOld.length;i<ii;i++){let po=contentOld[i],bExists=!1;for(let j=0,jj=content.length;j<jj;j++){if(content[j].url===po.url){bExists=!0;break}}bExists||contentRemoved.push(po)}let contentCreated=[];for(const p of content){TcHmi.System.Data.isLoadSyncContent.set(p.url,p.loadSync??!1);let bExists=!1;for(let j=0,jj=contentOld.length;j<jj;j++){let po=contentOld[j];if(p.url===po.url){bExists=!0;break}}bExists||contentCreated.push(p)}for(let i=0,ii=contentRemoved.length;i<ii;i++){let c=contentRemoved[i];if(void 0===c.url||null===c.url)continue;let cleanUrl=tchmi_path(c.url);TcHmi.System.Data.Caches.partialMarkupCache.delete(cleanUrl),TcHmi.EventProvider.raise("System.onContentRemoved",{url:cleanUrl})}for(let i=0,ii=contentCreated.length;i<ii;i++){let v=contentCreated[i];this.__loadViewPartial(v,this.__loadViewPartialCallback)}}__loadUserControlPartial(uc,callback){let ucm=null,ucc=null,uccUrl=uc.url.replace(".usercontrol",".usercontrol.json"),xhrDescr=new XMLHttpRequest;xhrDescr.open("GET",tchmi_encode_uri_components(uc.url)+"?preventcache="+Math.random()),xhrDescr.addEventListener("load",(_event=>{if(200===xhrDescr.status){ucm=xhrDescr.responseText;let xhr=new XMLHttpRequest;xhr.open("GET",tchmi_encode_uri_components(uccUrl)+"?preventcache="+Math.random()),xhr.addEventListener("load",(_event=>{200===xhr.status?ucc=TcHmi.ValueConverter.toObject(xhr.responseText):TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+uccUrl+" Details: HTTP error "+xhr.status+" "+xhr.statusText),TcHmi.Callback.callSafeEx(callback,null,uc,ucm,ucc)})),xhr.addEventListener("error",(_event=>{TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+uccUrl+" Details: HTTP error "+xhr.status+" "+xhr.statusText),TcHmi.Callback.callSafeEx(callback,null,uc,ucm,ucc)})),xhr.send()}else TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+uc.url+" Details: HTTP error "+xhrDescr.status+" "+xhrDescr.statusText),TcHmi.Callback.callSafeEx(callback,null,uc,ucm,ucc)})),xhrDescr.addEventListener("error",(_event=>{TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+uc.url+", status="+xhrDescr.status),TcHmi.Callback.callSafeEx(callback,null,uc,ucm,ucc)})),xhrDescr.send()}__loadUserControlPartialCallback(uc,ucm,ucc){if(null==ucm)return;let cacheEntry,cleanUcUrl=tchmi_path(uc.url),cleanUcConfigUrl=tchmi_path(uc.url.replace(".usercontrol",".usercontrol.json"));void 0!==uc.url&&null!==uc.url&&(cacheEntry={markup:ucm},TcHmi.System.Data.Caches.partialMarkupCache.set(cleanUcUrl,cacheEntry)),null!=ucc&&void 0!==uc.url&&null!==uc.url&&TcHmi.System.Data.Caches.partialCompositeConfigCache.set(cleanUcConfigUrl,ucc),TcHmi.EventProvider.raise("System.onUserControlCreated",{url:cleanUcUrl}),TcHmi.EventProvider.raise("System.onUserControlConfigCreated",{url:cleanUcConfigUrl})}__refreshUserControlPartials(userControls,userControlsOld){if(null==userControls||null==userControlsOld)return;let userControlsRemoved=[];for(let i=0,ii=userControlsOld.length;i<ii;i++){let po=userControlsOld[i],bExists=!1;for(let j=0,jj=userControls.length;j<jj;j++){userControls[j].url===po.url&&(bExists=!0)}bExists||userControlsRemoved.push(po)}let userControlsCreated=[];for(let i=0,ii=userControls.length;i<ii;i++){let p=userControls[i],bExists=!1;for(let j=0,jj=userControlsOld.length;j<jj;j++){let po=userControlsOld[j];p.url===po.url&&(bExists=!0)}bExists||userControlsCreated.push(p)}for(let i=0,ii=userControlsRemoved.length;i<ii;i++){let uc=userControlsRemoved[i];if(void 0===uc.url||null===uc.url)continue;let cleanUcUrl=tchmi_path(uc.url),cleanUcConfigUrl=tchmi_path(uc.url.replace(".usercontrol",".usercontrol.json"));TcHmi.System.Data.Caches.partialMarkupCache.delete(cleanUcUrl),TcHmi.System.Data.Caches.partialCompositeConfigCache.delete(cleanUcConfigUrl),TcHmi.EventProvider.raise("System.onUserControlRemoved",{url:cleanUcUrl}),TcHmi.EventProvider.raise("System.onUserControlConfigRemoved",{url:cleanUcConfigUrl})}for(const uc of userControlsCreated)this.__loadUserControlPartial(uc,this.__loadUserControlPartialCallback)}__refreshSymbolsInternal(symbols,symbolsOld){let i=0,ii=0,key=null,keyOld=null,bRemove=!1,remove=[],bCreate=!1,create=[],update=[];if(null!=symbolsOld&&null!=symbols)for(keyOld in symbolsOld)if(symbolsOld.hasOwnProperty(keyOld)){for(key in bRemove=!0,symbols)if(symbols.hasOwnProperty(key)){if(keyOld===key){bRemove=!1;break}key=null}bRemove&&remove.push(keyOld),bRemove=!1,keyOld=null}for(i=0,ii=remove.length;i<ii;i++)TcHmi.System.Services.internalSymbolManager.remove(remove[i]);if(null!=symbolsOld&&null!=symbols)for(key in symbols)if(symbols.hasOwnProperty(key)){for(keyOld in bCreate=!0,symbolsOld)if(symbolsOld.hasOwnProperty(keyOld)&&key===keyOld){bCreate=!1,tchmi_equal(symbols[key].value,symbolsOld[keyOld].value)&&symbols[key].persist===symbolsOld[keyOld].persist&&symbols[key].type===symbolsOld[keyOld].type&&symbols[key].readonly===symbolsOld[keyOld].readonly||update.push({key,item:symbols[key]});break}bCreate&&create.push({key,item:symbols[key]})}for(const entry of create)TcHmi.System.Services.internalSymbolManager.add(entry.key,tchmi_clone_object(entry.item));for(const entry of update)TcHmi.System.Services.internalSymbolManager.update(entry.key,tchmi_clone_object(entry.item))}__refreshSymbolsTimer(symbols,symbolsOld){let i=0,ii=0,key=null,keyOld=null,bRemove=!1,remove=[],bCreate=!1,create=[],update=[];if(!tchmi_equal(symbols,symbolsOld)){if(TcHmi.System.Services.timerSymbolManager.stop(),null!=symbolsOld&&null!=symbols)for(keyOld in symbolsOld)if(symbolsOld.hasOwnProperty(keyOld)){for(key in bRemove=!0,symbols)if(symbols.hasOwnProperty(key)){if(keyOld===key){bRemove=!1;break}key=null}bRemove&&remove.push(keyOld),bRemove=!1,keyOld=null}for(i=0,ii=remove.length;i<ii;i++)TcHmi.System.Services.timerSymbolManager.remove(remove[i]);if(null!=symbolsOld&&null!=symbols)for(key in symbols)if(symbols.hasOwnProperty(key)){for(keyOld in bCreate=!0,symbolsOld)if(symbolsOld.hasOwnProperty(keyOld)&&key===keyOld){bCreate=!1,tchmi_equal(symbols[key],symbolsOld[keyOld])||update.push({key,item:symbols[key]});break}bCreate&&create.push({key,item:symbols[key]})}for(const entry of create)TcHmi.System.Services.timerSymbolManager.add(entry.key,tchmi_clone_object(entry.item));for(const entry of update)TcHmi.System.Services.timerSymbolManager.update(entry.key,tchmi_clone_object(entry.item));TcHmi.System.Services.timerSymbolManager.run()}}__refreshSymbols(symbols,symbolsOld){this.__refreshSymbolsInternal(symbols.internal,symbolsOld.internal),this.__refreshSymbolsTimer(symbols.timer,symbolsOld.timer),tchmi_equal(symbols.themedResources,symbolsOld.themedResources)||TcHmi.System.Services.themeManager.processThemedResources()}__refreshPackages(packages,packagesOld){let i=0,ii=0,j=0,jj=0,bCreate=!1,newPackages=[];if(null!=packages&&null!=packagesOld){for(i=0,ii=packages.length;i<ii;i++){for(bCreate=!0,j=0,jj=packagesOld.length;j<jj;j++)if(packages[i].name===packagesOld[j].name){bCreate=!1;break}bCreate&&newPackages.push(packages[i])}resourceInjectionManager.injectPackageResources(tchmi_clone_object(newPackages))}}__refreshUserFunctions(userFunctions,userFunctionsOld){let userFunctionsCreated=[];for(let i=0,ii=userFunctions.length;i<ii;i++){let userFunction=userFunctions[i],bExists=!1;if(userFunctionsOld)for(let j=0,jj=userFunctionsOld.length;j<jj;j++){let userFunctionOld=userFunctionsOld[j];if(tchmi_path(userFunction.url)===tchmi_path(userFunctionOld.url)){bExists=!0;break}}else bExists=!1;bExists||userFunctionsCreated.push(userFunction)}for(const userFunction of userFunctionsCreated){let url=tchmi_path(userFunction.url.replace(".js",".function.json").replace(".mjs",".function.json")),xhr=new XMLHttpRequest;xhr.open("GET",encodeURIComponent(url)+"?preventcache="+Math.random()),xhr.addEventListener("load",(_event=>{if(200===xhr.status){let descr=TcHmi.ValueConverter.toObject(xhr.responseText);if(!descr)return void TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while parsing object loaded from "+url);let name=descr.function.name,namespace=descr.function.namespace,qname=TcHmi.System.resolveQualifiedName(name,namespace),registration=TcHmi.System.Data.Registrations.functions.map.get(name),add=function(){if(!registration?.name)return;let name=registration.name,qname=TcHmi.System.resolveQualifiedName(registration.name,registration.namespace),module={error:TcHmi.Errors.NONE,reg:registration,description:descr};TcHmi.System.Data.Modules.functions.map.has(name)?TcHmi.System.Data.Modules.functions.map.set(name,{error:TcHmi.Errors.E_NOT_UNIQUE,errorDetails:{code:TcHmi.Errors.E_NOT_UNIQUE,message:TcHmi.Errors[TcHmi.Errors.E_NOT_UNIQUE]}}):TcHmi.System.Data.Modules.functions.map.set(name,module),qname!==name&&(TcHmi.System.Data.Modules.functions.map.has(qname)?TcHmi.System.Data.Modules.functions.map.set(qname,{error:TcHmi.Errors.E_NOT_UNIQUE,errorDetails:{code:TcHmi.Errors.E_NOT_UNIQUE,message:TcHmi.Errors[TcHmi.Errors.E_NOT_UNIQUE]}}):TcHmi.System.Data.Modules.functions.map.set(qname,module))};registration&&registration.error!==TcHmi.Errors.E_NOT_UNIQUE||(registration=TcHmi.System.Data.Registrations.functions.map.get(qname),registration?add():TcHmi.EventProvider.register("System.onFunctionRegistered",((event,data)=>{event.destroy(),registration=data,add()})))}else TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+url+" Details: HTTP error "+xhr.status+" "+xhr.statusText)})),xhr.addEventListener("error",(_event=>{TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+url+" Details: HTTP error "+xhr.status+" "+xhr.statusText)})),xhr.send()}}__refreshDependencyFiles(dependencyFiles,dependencyFilesOld){if(!dependencyFiles||!dependencyFilesOld)return;let dependencyFilesCreated=[];for(const dependencyFile of dependencyFiles){if("Stylesheet"===dependencyFile.type)continue;const normalizedPath=tchmi_path(dependencyFile.name);let bExists=!1;for(const scriptElem of document.scripts)if(normalizedPath===tchmi_path(scriptElem.getAttribute("src"))){if("EsModule"===dependencyFile.type&&"module"===scriptElem.type){bExists=!0;break}if("JavaScript"!==dependencyFile.type||scriptElem.type)return void designerModeManager.lock();bExists=!0;break}bExists||dependencyFilesCreated.push(dependencyFile)}if(dependencyFilesCreated.length>0){const fragment=document.createDocumentFragment();for(const dependencyFile of dependencyFilesCreated){const script=document.createElement("script");script.src=tchmi_path(dependencyFile.name),"EsModule"===dependencyFile.type?script.type="module":script.async=!1,fragment.appendChild(script)}document.head.appendChild(fragment)}}__refreshLanguageFallback(languageFallback,languageFallbackOld){languageFallback!==languageFallbackOld&&(TcHmi.System.Services.localizationManager.setFallbackLocale(languageFallback),TcHmi.System.Services.localizationManager.resetFallbackLocale())}__refreshLanguage(languages,languagesOld){if(!tchmi_equal(languages,languagesOld)){for(const[key,languageEntry]of Object.entries(languagesOld))if(Array.isArray(languageEntry)){const sanitizedLanguageArray=[];for(const subEntry of languageEntry)sanitizedLanguageArray.push(tchmi_path(subEntry));TcHmi.System.Services.localizationManager.unregisterLocalizationFile("TcHmi.System.Localization.Application",key,sanitizedLanguageArray)}else languageEntry&&TcHmi.System.Services.localizationManager.unregisterLocalizationFile("TcHmi.System.Localization.Application",key,tchmi_path(languageEntry));for(const[key,languageEntry]of Object.entries(languages))if(Array.isArray(languageEntry)){const sanitizedLanguageArray=[];for(const subEntry of languageEntry)sanitizedLanguageArray.push(tchmi_path(subEntry));TcHmi.System.Services.localizationManager.registerLocalizationFile("TcHmi.System.Localization.Application",key,sanitizedLanguageArray)}else languageEntry&&TcHmi.System.Services.localizationManager.registerLocalizationFile("TcHmi.System.Localization.Application",key,tchmi_path(languageEntry))}}__refreshSystemKeyboard(keyboardDefinition,keyboardDefinitionOld){tchmi_equal(keyboardDefinition,keyboardDefinitionOld)||TcHmi.System.Services.keyboardManager?.refreshConfig()}__refreshIntervals(intervals,intervalsOld){let i=0,ii=0,key=null,keyOld=null,bRemove=!1,remove=[],bCreate=!1,create=[],update=[];if(null!=intervalsOld&&null!=intervals)for(keyOld in intervalsOld)if(intervalsOld.hasOwnProperty(keyOld)){for(key in bRemove=!0,intervals)if(intervals.hasOwnProperty(key)){if(keyOld===key){bRemove=!1;break}key=null}bRemove&&remove.push(keyOld),bRemove=!1,keyOld=null}for(i=0,ii=remove.length;i<ii;i++)TcHmi.System.Services.intervalManager.remove(remove[i]);if(null!=intervalsOld&&null!=intervals)for(key in intervals)if(intervals.hasOwnProperty(key)){for(keyOld in bCreate=!0,intervalsOld)if(intervalsOld.hasOwnProperty(keyOld)&&key===keyOld){bCreate=!1,tchmi_equal(intervals[key],intervalsOld[keyOld])||update.push({key,item:intervals[key]});break}bCreate&&create.push({key,item:intervals[key]})}for(const entry of create)TcHmi.System.Services.intervalManager.add(entry.key,tchmi_clone_object(entry.item));for(const entry of update)TcHmi.System.Services.intervalManager.update(entry.key,tchmi_clone_object(entry.item))}__doReloadTcHmiConfig(url){let config=null,configOld=TcHmi.System.config,xhr=new XMLHttpRequest;xhr.open("GET","Properties/tchmiconfig.json?preventcache="+Math.random()),xhr.addEventListener("load",(_event=>{if(200===xhr.status){if(config=TcHmi.ValueConverter.toObject(xhr.responseText),null===config)return;this.__doRefreshTcHmiConfig(config,configOld)}else TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+url+" Command will be ignored. Details: HTTP error "+xhr.status+" "+xhr.statusText)})),xhr.addEventListener("error",(_event=>{TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+url+" Command will be ignored. HTTP error "+xhr.status+" "+xhr.statusText)})),xhr.send()}__doRefreshTcHmiConfig(config,configOld){TcHmi.System.config=config,TcHmi.System.config.basePath=configOld.basePath,TcHmi.System.config.tcHmiServer?TcHmi.System.config.tcHmiServer.websocketIntervalTime||(TcHmi.System.config.tcHmiServer.websocketIntervalTime=configOld.tcHmiServer.websocketIntervalTime):TcHmi.System.config.tcHmiServer=configOld.tcHmiServer,this.__refreshBaseConfig(config,configOld),this.__refreshViewPartials(config.views,configOld.views),this.__refreshContentPartials(config.content,configOld.content),this.__refreshUserControlPartials(config.userControls,configOld.userControls),this.__refreshSymbols(config.symbols,configOld.symbols),this.__refreshPackages(config.packages,configOld.packages),this.__refreshUserFunctions(config.userFunctions,configOld.userFunctions),this.__refreshDependencyFiles(config.dependencyFiles,configOld.dependencyFiles),this.__refreshLanguage(config.languages,configOld.languages),this.__refreshLanguageFallback(config.languageFallback,configOld.languageFallback),this.__refreshSystemKeyboard(config.systemKeyboard,configOld.systemKeyboard),this.__refreshIntervals(config.intervals,configOld.intervals),tchmi_equal(config,configOld)||TcHmi.EventProvider.raise("onConfigChanged",{configNew:config,configOld})}__doReloadUserControlConfig(url){let xhr=new XMLHttpRequest;xhr.open("GET",tchmi_encode_uri_components(url)+"?preventcache="+Math.random()),xhr.addEventListener("load",(_event=>{if(200===xhr.status){let data=TcHmi.ValueConverter.toObject(xhr.responseText);data?this.__doRefreshUserControlConfig(url,data):TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while parsing file loaded from "+url)}else TcHmi.EventProvider.raise("System.onUserControlConfigRemoved",{url})})),xhr.addEventListener("error",(_event=>{TcHmi.EventProvider.raise("System.onUserControlConfigRemoved",{url})})),xhr.send()}__doRefreshUserControlConfig(url,data){TcHmi.System.Data.Caches.partialCompositeConfigCache.set(url,data),TcHmi.EventProvider.raise("System.onUserControlConfigChanged",{url})}__doReloadLocalizationFile(url){let xhr=new XMLHttpRequest;xhr.open("GET",tchmi_encode_uri_components(url)+"?preventcache="+Math.random()),xhr.addEventListener("load",(_event=>{if(200===xhr.status){let data=TcHmi.ValueConverter.toObject(xhr.responseText);data?this.__doRefreshLocalizationFile(url,data):TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while parsing file loaded from "+url)}else TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+url+" Details: HTTP error "+xhr.status+" "+xhr.statusText)})),xhr.addEventListener("error",(_event=>{TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+url+". Details: "+xhr.statusText)})),xhr.send()}__doRefreshLocalizationFile(url,data){let locale=data.locale;if(null==locale)return;TcHmi.System.Services.localizationManager.clearFileFetchCache();let currentLocaleData=TcHmi.System.Services.localizationManager.getLocaleData("TcHmi.System.Localization.Application"),currentLocaleFallbackData=TcHmi.System.Services.localizationManager.getLocaleFallbackData("TcHmi.System.Localization.Application");currentLocaleData&&currentLocaleData.locale===locale&&(TcHmi.System.Services.localizationManager.setLocaleData("TcHmi.System.Localization.Application",data,url),currentLocaleData=TcHmi.System.Services.localizationManager.getLocaleData("TcHmi.System.Localization.Application"),TcHmi.System.Services.localizationManager.processLocalizationData("TcHmi.System.Localization.Application",currentLocaleData,currentLocaleFallbackData)),currentLocaleFallbackData&&currentLocaleFallbackData.locale===locale&&(TcHmi.System.Services.localizationManager.setLocaleFallbackData("TcHmi.System.Localization.Application",data,url),currentLocaleFallbackData=TcHmi.System.Services.localizationManager.getLocaleFallbackData("TcHmi.System.Localization.Application"),TcHmi.System.Services.localizationManager.processLocalizationData("TcHmi.System.Localization.Application",currentLocaleData,currentLocaleFallbackData)),TcHmi.System.Services.localizationManager.processPendingEntryWatches(),TcHmi.System.Services.localizationManager.processLocalizationWatches("TcHmi.System.Localization.Application")}__doRefreshThemeFile(url){TcHmi.System.Services.themeManager.__clearProjectThemeUrl(url),TcHmi.System.Services.themeManager.processActiveTheme()}run(){let cmd=this.__cmd,preparedConfigPath=tchmi_path(cmd.configPath);switch(cmd.type){case"TcHmiConfig":this.__doReloadTcHmiConfig(preparedConfigPath);break;case"UserControlConfig":this.__doReloadUserControlConfig(preparedConfigPath);break;case"Localization":this.__doReloadLocalizationFile(preparedConfigPath);break;case"ThemeConfig":this.__doRefreshThemeFile(preparedConfigPath)}}}SyncCmdToFrameworkTcHmiConfigChanged.supportedCommand="TcHmiConfigChanged",registerCommand(SyncCmdToFrameworkTcHmiConfigChanged);